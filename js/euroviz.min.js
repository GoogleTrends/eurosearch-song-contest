/*!
 * Euroviz - Euroviz v<%= pkg.version 
 */
$(window).on("load",function(){function e(){$(".navbar").offset().top>50?$(".navbar-fixed-top").addClass("top-nav-collapse"):$(".navbar-fixed-top").removeClass("top-nav-collapse")}function t(){function e(e){e.each(function(e){var r=d3.select(this).append("svg"),a=r.append("g");r.attr("width",n).attr("height",o);var c=Math.min(Math.floor((o-t.top)/10),Math.floor((n-t.top)/10)),l=(n-10*c)/2,a=r.select("g").attr("transform","translate("+l+",2)");a.selectAll("rect").data(e).enter().append("rect").attr("x",function(e){return c*e.x}).attr("y",function(e){return c*e.y}).attr("height",c).attr("width",c).attr("class",function(e){return"id-"+e.countrycode}).style("fill","#aaaaaa").style("stroke",i).style("stroke-width",2),a.selectAll("text").data(e).enter().append("text").attr("x",function(e){return c*(e.x+.5)}).attr("y",function(e){return c*(e.y+.6)}).style("text-anchor","middle").style("fill","#ffffff").style("opacity",.5).style("font-size",10).style("font-family","Roboto").text(function(e){return e.countrycode})})}var t={top:2,right:0,bottom:0,left:0},n=760,o=500,r=function(e){return e[1]},a=function(e){return e[2]},i="#cccccc";return e.margin=function(n){return arguments.length?(t=n,e):t},e.width=function(t){return arguments.length?(n=t,e):n},e.height=function(t){return arguments.length?(o=t,e):o},e.x=function(t){return arguments.length?(r=t,e):r},e.y=function(t){return arguments.length?(a=t,e):a},e.strokecolor=function(t){return arguments.length?(i=t,e):i},e}$(window).scroll(e),$(document).ready(e),$(function(){$("a.page-scroll").bind("click",function(e){var t=$(this);$("html, body").stop().animate({scrollTop:$(t.attr("href")).offset().top},1500,"easeInOutExpo"),e.preventDefault()})}),$(".navbar-collapse ul li a").click(function(){$(".navbar-collapse").collapse("hide")});var n=document.documentElement.clientWidth;n>1e3&&(n=1e3);var o=.7,r=n*o,a={width:n,height:r,padding:10,projection:d3.geoMercator(),duration:0,key:function(e){return e.properties.ISO_A3},grid:{ALB:{x:5,y:8},ARM:{x:9,y:6},AUS:{x:9,y:9},AUT:{x:4,y:5},AZE:{x:9,y:5},BEL:{x:2,y:3},BGR:{x:7,y:6},BIH:{x:5,y:6},BLR:{x:6,y:3},CHE:{x:3,y:4},CYP:{x:8,y:7},CZE:{x:4,y:4},DEU:{x:4,y:3},DNK:{x:4,y:2},ESP:{x:1,y:5},EST:{x:6,y:1},FIN:{x:6,y:0},FRA:{x:1,y:4},GBR:{x:1,y:2},GEO:{x:8,y:5},GRC:{x:6,y:8},HUN:{x:5,y:5},HRV:{x:4,y:6},IRL:{x:0,y:2},ISL:{x:0,y:0},ISR:{x:8,y:8},ITA:{x:3,y:5},KOS:{x:6,y:7},LTU:{x:6,y:2},LUX:{x:2,y:4},LVA:{x:7,y:2},MDA:{x:7,y:5},MKD:{x:7,y:7},MLT:{x:1,y:7},MNE:{x:5,y:7},NLD:{x:3,y:3},NOR:{x:4,y:0},POL:{x:5,y:3},PRT:{x:0,y:5},ROU:{x:6,y:5},RUS:{x:7,y:3},SMR:{x:2,y:6},SRB:{x:6,y:6},SVK:{x:5,y:4},SVN:{x:3,y:6},SWE:{x:5,y:0},UKR:{x:6,y:4},TUR:{x:8,y:6}}},i=[{countrycode:"ALB",countrycode2:"al",qualifiedreal:!1,name:"Albania",round:"first",qualified:!0},{countrycode:"ARM",countrycode2:"ar",qualifiedreal:!0,name:"Armenia",round:"first",qualified:!0},{countrycode:"AUS",countrycode2:"au",qualifiedreal:!0,name:"Australia",round:"first",qualified:!0},{countrycode:"AUT",countrycode2:"at",qualifiedreal:!0,name:"Austria",round:"second",qualified:!0},{countrycode:"AZE",countrycode2:"az",qualifiedreal:!0,name:"Azerbaijan",round:"first",qualified:!0},{countrycode:"BEL",countrycode2:"be",qualifiedreal:!0,name:"Belgium",round:"first",qualified:!0},{countrycode:"BGR",countrycode2:"bg",qualifiedreal:!0,name:"Bulgaria",round:"second",qualified:!0},{countrycode:"BIH",countrycode2:"bi",qualifiedreal:!1,name:"Bosnia and Herzegovina",round:"none",qualified:!1},{countrycode:"BLR",countrycode2:"by",qualifiedreal:!0,name:"Belarus",round:"second",qualified:!1},{countrycode:"CHE",countrycode2:"ch",qualifiedreal:!1,name:"Switzerland",round:"second",qualified:!0},{countrycode:"CYP",countrycode2:"cy",qualifiedreal:!0,name:"Cyprus",round:"first",qualified:!0},{countrycode:"CZE",countrycode2:"cz",qualifiedreal:!1,name:"Czech Republic",round:"first",qualified:!1},{countrycode:"DEU",countrycode2:"de",qualifiedreal:!0,name:"Germany",round:"final",qualified:!0},{countrycode:"DNK",countrycode2:"dk",qualifiedreal:!0,name:"Denmark",round:"second",qualified:!0},{countrycode:"ESP",countrycode2:"es",qualifiedreal:!0,name:"Spain",round:"final",qualified:!0},{countrycode:"EST",countrycode2:"ee",qualifiedreal:!1,name:"Estonia",round:"second",qualified:!1},{countrycode:"FIN",countrycode2:"fi",qualifiedreal:!1,name:"Finland",round:"first",qualified:!0},{countrycode:"FRA",countrycode2:"fr",qualifiedreal:!0,name:"France",round:"final",qualified:!0},{countrycode:"GBR",countrycode2:"gb",qualifiedreal:!0,name:"Great Brittain",round:"final",qualified:!0},{countrycode:"GEO",countrycode2:"ge",qualifiedreal:!1,name:"Georgia",round:"first",qualified:!1},{countrycode:"GRC",countrycode2:"gr",qualifiedreal:!0,name:"Greece",round:"first",qualified:!0},{countrycode:"HUN",countrycode2:"hu",qualifiedreal:!0,name:"Hungary",round:"second",qualified:!0},{countrycode:"HRV",countrycode2:"hr",qualifiedreal:!0,name:"Croatia",round:"second",qualified:!0},{countrycode:"IRL",countrycode2:"ie",qualifiedreal:!1,name:"Ireland",round:"second",qualified:!0},{countrycode:"ISL",countrycode2:"is",qualifiedreal:!1,name:"Iceland",round:"first",qualified:!1},{countrycode:"ISR",countrycode2:"il",qualifiedreal:!0,name:"Israel",round:"second",qualified:!0},{countrycode:"ITA",countrycode2:"it",qualifiedreal:!0,name:"Italia",round:"final",qualified:!0},{countrycode:"KOS",countrycode2:"ko",qualifiedreal:!1,name:"Kosovo",round:"none",qualified:!1},{countrycode:"LTU",countrycode2:"lt",qualifiedreal:!1,name:"Lithuania",round:"second",qualified:!1},{countrycode:"LUX",countrycode2:"lu",qualifiedreal:!1,name:"Luxembourg",round:"none",qualified:!1},{countrycode:"LVA",countrycode2:"lv",qualifiedreal:!1,name:"Latvia",round:"first",qualified:!1},{countrycode:"MDA",countrycode2:"md",qualifiedreal:!0,name:"Moldova",round:"first",qualified:!1},{countrycode:"MKD",countrycode2:"mk",qualifiedreal:!1,name:"Macedonia",round:"second",qualified:!1},{countrycode:"MLT",countrycode2:"ml",qualifiedreal:!1,name:"Malta",round:"second",qualified:!1},{countrycode:"MNE",countrycode2:"me",qualifiedreal:!1,name:"Montenegro",round:"first",qualified:!1},{countrycode:"NLD",countrycode2:"nl",qualifiedreal:!0,name:"Netherlands",round:"second",qualified:!0},{countrycode:"NOR",countrycode2:"no",qualifiedreal:!0,name:"Norway",round:"second",qualified:!1},{countrycode:"POL",countrycode2:"pl",qualifiedreal:!0,name:"Poland",round:"first",qualified:!1},{countrycode:"PRT",countrycode2:"pt",qualifiedreal:!0,name:"Portugal",round:"first",qualified:!0},{countrycode:"ROU",countrycode2:"ro",qualifiedreal:!0,name:"Romania",round:"second",qualified:!1},{countrycode:"RUS",countrycode2:"ru",qualifiedreal:!1,name:"Russia",round:"none",qualified:!1},{countrycode:"SMR",countrycode2:"sm",qualifiedreal:!1,name:"San Marino",round:"second",qualified:!1},{countrycode:"SRB",countrycode2:"rs",qualifiedreal:!1,name:"Serbia",round:"second",qualified:!0},{countrycode:"SVK",countrycode2:"sk",qualifiedreal:!1,name:"Slovakia",round:"none",qualified:!1},{countrycode:"SVN",countrycode2:"si",qualifiedreal:!1,name:"Slovenia",round:"first",qualified:!1},{countrycode:"SWE",countrycode2:"se",qualifiedreal:!0,name:"Sweden",round:"first",qualified:!0},{countrycode:"UKR",countrycode2:"ua",qualifiedreal:!0,name:"Ukraine",round:"final",qualified:!0},{countrycode:"TUR",countrycode2:"tr",qualifiedreal:!1,name:"Turkey",round:"none",qualified:!1}],c=[],l=[],d=[],u=[],s=[],f=[],y=[];i.forEach(function(e){if("final"==e.round){var t={};t.countrycode=e.countrycode,t.name=e.name,c.push(t)}if(e.qualified||"none"==e.round||l.push(e.countrycode),e.qualifiedreal||"none"==e.round||d.push(e.countrycode),("first"==e.round||"second"==e.round)&&e.qualified){var t={};t.countrycode=e.countrycode,t.name=e.name,u.push(t)}if(("first"==e.round||"second"==e.round)&&e.qualifiedreal){var t={};t.countrycode=e.countrycode,t.name=e.name,s.push(t)}"none"==e.round&&f.push(e.countrycode),"none"!=e.round&&y.push(e.countrycode)});var p=c.concat(s);p=p.sort(function(e,t){var n=e.name,o=t.name;return n<o?-1:n>o?1:void 0}),d3.csv("data/votes_20170512.csv",function(e){d3.csv("data/votes_real_mock_20170503.csv",function(o){d3.csv("data/countrylookup.csv",function(r){function i(t,n){if("from"==n){var o=e.filter(function(e){return e.from==t&&0!=e.points});return o.sort(function(e,t){return t.points-e.points}),o}if("to"==n){var r=e.filter(function(e){return e.to==t&&0!=e.points});return r.sort(function(e,t){return e.points-t.points}),r}}function y(e){d3.selectAll("#map-three circle").interrupt(),d3.selectAll("#map-three rect").style("stroke-width",2),d3.selectAll("#map-three rect").style("fill","#7e7eb4"),p.forEach(function(e){d3.selectAll("#map-three rect.id-"+e.countrycode).style("fill","#ff5454")}),d3.selectAll("#map-three rect.nonparticipant").style("fill","#777777"),d3.selectAll("#map-three circle").remove(),d3.selectAll("#country-list li").remove(),d3.selectAll("#country-list-real li").remove(),$(".btn.btn-default.dropdown-toggle").html(h[e].name+' <span class="caret"></span>'),$(".btn.btn-default.dropdown-toggle").val($(e).data("value"));var t=i(e,"from"),n=U.selectAll("circle").data(t).enter().append("circle").attr("cx",S*a.grid[e].x+.5*S).attr("cy",S*a.grid[e].y+.5*S).attr("r",function(e){return e.points}).style("fill","none").style("stroke","#ffffff").style("stroke-width",2);d3.selectAll("#map-three text").raise().style("fill","#ffffff").style("opacity",.5),n.transition().ease(d3.easeExpInOut).delay(function(e,n){return 600*(t.length-1-n)}).duration(3e3).attr("cx",function(e,t){return S*a.grid[e.to].x+.5*S}).attr("cy",function(e,t){return S*a.grid[e.to].y+.5*S}).on("end",function(e,t){d3.select("#country-list-real").insert("li",":first-child").html('<div class="pull-left points" width="30px">'+e.points+'</div> <span class="highlight losers">?</span>'),d3.select("#country-list").insert("li",":first-child").html('<div class="pull-left points" width="30px">'+e.points+'</div> <span class="flag-icon flag-icon-'+h[e.to].iso2+' flag-icon-squared"></span> '+h[e.to].name)}),d3.select("#map-three rect.id-"+e).raise().transition().duration(500).style("fill","#ffffff"),d3.select("#map-three text.id-"+e).raise().transition().duration(500).style("fill","#ff5454").style("opacity",1)}function m(e){var n;"google"==e&&(n=v),"real"==e&&(n=x),n.forEach(function(e,t){var n=d3.select("div#smallmultiples");n.append("div").attr("class","row row-"+e.key);var o=d3.select(".row.row-"+e.key);o.append("h3").html(t+1+'. <span class="flag-icon flag-icon-'+h[e.key].iso2+' flag-icon-squared"></span> '+h[e.key].name);var r=o.append("div").attr("class","col-md-6 col-xs-12").append("div");r.append("h4").text("Searches: "+e.value+" points"),r.append("div").attr("class","smallmultiple google "+e.key);var a=o.append("div").attr("class","col-md-6 col-xs-12").append("div");a.append("h4").text("Eurovision votes: available after May 13th"),a.append("div").attr("class","smallmultiple real "+e.key)});var o=t().x(function(e){return+e.x}).y(function(e){return+e.y}),r=d3.select(".smallmultiple").node().getBoundingClientRect().width;r>300&&(r=300),d3.selectAll(".smallmultiple").datum(M).call(o.width(r).height(r).strokecolor("#ffffff"));var a=d3.scaleSequential(d3.interpolateInferno).domain([14,0]);d3.selectAll(".legend-item").style("background-color",function(e){return a(d3.select(this).text())}),p.forEach(function(e){d3.selectAll(".smallmultiple."+e.countrycode+" rect.id-"+e.countrycode).raise().style("fill","#000000").style("stroke","#ffffff").style("stroke-width","6px");var t=i(e.countrycode,"to");t.forEach(function(t){d3.select(".smallmultiple.google."+e.countrycode+" rect.id-"+t.from).style("fill",a(t.points))})})}var h={},g={};r.forEach(function(e){var t={};t.name=e.name,t.iso2=e.iso2,h[e.ISO3]=t,g[e.ISO3]=0}),e.forEach(function(e){e.points=+e.points}),o.forEach(function(e){e.points=+e.points});var v=d3.nest().key(function(e){return e.to}).sortKeys(d3.ascending).rollup(function(e){return d3.sum(e,function(e){return e.points})}).entries(e);v=v.sort(function(e,t){return t.value-e.value});var x=d3.nest().key(function(e){return e.to}).sortKeys(d3.ascending).rollup(function(e){return d3.sum(e,function(e){return e.points})}).entries(o);x=x.sort(function(e,t){return t.value-e.value});var q=[];v.forEach(function(e,t){var n={};n.countrycode=e.key,n.googlerank=t+1,x.forEach(function(t,o){e.key==t.key&&(n.realrank=o+1)}),q.push(n)}),$(".dropdown-menu li div").click(function(){var e=$(this).data("value");y(e)});var A=d3.select("#map-one").append("svg").attr("width",a.width).attr("height",a.height),w=d3.select("#map-two").append("svg").attr("width",a.width).attr("height",a.height),k=$("#map-three").width();k>500&&(k=500);var R=d3.select("#map-three").append("svg").attr("width",k).attr("height",k+20),E=d3.select("#slopegraph").append("svg").attr("width",300).attr("height",700),S=Math.floor((k-4)/10),b=(k-10*S)/2,U=R.append("g").attr("transform","translate("+(2+b)+",2)");for(country in a.grid){var r=a.grid[country];U.append("rect").attr("x",S*r.x).attr("y",S*r.y).attr("height",S).attr("width",S).attr("class",function(){return"RUS"==country||"LUX"==country||"BIH"==country||"SVK"==country||"TUR"==country||"KOS"==country?"nonparticipant id-"+country:"id-"+country}).style("fill","#7e7eb4").style("stroke","#ffffff").style("stroke-width",2),U.append("text").attr("x",S*r.x+S/2).attr("y",S*r.y+S/2+4).style("fill","#ffffff").style("text-anchor","middle").style("opacity",.5).style("font-size",12).style("font-family","Roboto").attr("class",function(){return"RUS"==country||"LUX"==country||"BIH"==country||"SVK"==country||"TUR"==country||"KOS"==country?"nonparticipant id-"+country:"id-"+country}).text(country)}d3.selectAll("#map-three svg g rect:not(.nonparticipant), #map-three svg g text:not(.nonparticipant)").on("click",function(){var e=d3.select(this).attr("class").substring(3,6);y(e)});var L=d3.scaleSequential(d3.interpolatePlasma);L.domain([0,d3.max(v,function(e){return e.value})]);var I=d3.scaleLinear().domain([0,d3.max(v,function(e){return e.value})]).range([.2,1]);E.append("text").attr("x",130).attr("y",20).attr("text-anchor","middle").attr("font-size","16px").attr("font-family","Roboto").text("Search"),E.append("text").attr("x",230).attr("y",20).attr("font-size","16px").attr("text-anchor","middle").style("font-family","Roboto").text("Real votes");var B=24;E.selectAll("image").data(v).enter().append("image").attr("xlink:href",function(e){return"flags/round/svg/"+e.key+".svg"}).attr("x",120).attr("y",function(e,t){return 30+B*t}).attr("class",function(e){return"id-"+e.key}).attr("width",B-2).attr("height",B-2);E.selectAll("text.countrylabel").data(v).enter().append("text").attr("x",0).attr("y",function(e,t){return B*t+46}).style("font-family","Roboto").style("font-size","14px").attr("class",function(e){return"countrylabel id-"+e.key}).attr("id",function(e){return e.key}).style("fill","#000037").style("opacity",function(e){return I(e.value)}).html(function(e,t){return t+1+". "+h[e.key].name+': <tspan class="score id-'+e.key+'">'+e.value+"</tspan>"});E.selectAll("image.real").data(x).enter().append("image").attr("xlink:href","img/questionmark-circle.svg").attr("x",220).attr("y",function(e,t){return 30+B*t}).attr("class",function(e){return"id-"+e.key}).attr("width",B-2).attr("height",B-2);var M=[],T=[];for(country in a.grid){var r=a.grid[country],K={};K.countrycode=country,K.x=r.x,K.y=r.y,M.push(K),"KOS"!=K.countrycode&&"LUX"!=K.countrycode&&"BIH"!=K.countrycode&&"TUR"!=K.countrycode&&"SVK"!=K.countrycode&&T.push(K)}M.sort(function(e,t){var n=e.y-t.y;return 0==n?e.x-t.x:n}),m("google");var O=new geo2rect.draw;d3.json("./data/eurovis-countries-simplified-sanmarino.geojson",function(e,t){var o=d3.geoMercator().center([20,51]).scale(.65*n).translate([a.width/2,a.height/2]),r=d3.geoPath().projection(o),i=t.features;A.selectAll("path").data(i).enter().append("path").attr("class",function(e){return"id-"+e.properties.ISO_A3}).attr("d",r);var y={FRA:[2.456,47.155],ESP:[-3.97,40.328],DEU:[10.406,51.186],GBR:[-1.961,52.441],UKR:[33.028,48.27],TUR:[35.36,38.873],POL:[19.284,51.987],RUS:[37.531,55.714],ITA:[9.884,44.866],BLR:[27.882,53.209],ROU:[24.671,45.815]};for(country in y)var m=d3.select("#map-one svg").append("text").attr("x",o(y[country])[0]).attr("y",o(y[country])[1]).attr("class","map-one-label").text(h[country].name);var g=[30.515,50.456],v=[30.899,50.756];d3.select("#map-one svg").append("rect").attr("x",o(g)[0]).attr("y",o(g)[1]).attr("height",8).attr("width",8).style("stroke","#ffffff").style("fill","none").style("stroke-width",2),d3.select("#map-one svg").append("text").attr("x",o(v)[0]).attr("y",o(v)[1]).attr("class","map-one-label").text("KIEV").style("opacity",1).style("text-anchor","start");var x=geo2rect.compute(t);O.config=a,O.data=x,O.svg=w.append("g"),O.toggle(),O.draw(),setTimeout(function(){for(country in a.grid)var e=d3.selectAll("#map-two svg g path.id-"+country).node().getBBox(),t=d3.select("#map-two svg g path.id-"+country).node().getCTM(),n=e.x+e.width/2+t.e,o=e.y+e.height/2+t.f,r=d3.select("#map-two svg").append("text").attr("x",n).attr("y",o+4).attr("class","map-two-label").text(country)},500),O.config.duration=3e3,c.forEach(function(e){d3.selectAll("#map-one svg .id-"+e.countrycode+", #map-two svg .id-"+e.countrycode).style("fill","#dc0000")}),l.forEach(function(e){d3.selectAll("#map-one svg .id-"+e).style("fill","#7e7eb4")}),u.forEach(function(e){d3.selectAll("#map-one svg .id-"+e.countrycode+", #map-two svg .id-"+e.countrycode).style("fill","#ff5454")}),s.forEach(function(e){d3.selectAll("#map-two svg .id-"+e.countrycode).style("fill","#ff5454")}),d.forEach(function(e){d3.selectAll("#map-two svg .id-"+e).style("fill","#7e7eb4")}),p.forEach(function(e){d3.selectAll("#map-three rect.id-"+e.countrycode).style("fill","#ff5454")}),f.forEach(function(e){d3.selectAll("#map-one svg path.id-"+e+", #map-two svg path.id-"+e+", #map-three svg rect.id-"+e).style("fill","#777777")})}),$("#real-search-switch-one").change(function(){var e=$(this);e.prop("disabled",!0),setTimeout(function(){e.prop("disabled",!1)},1e3),this.checked||(u.forEach(function(e){d3.selectAll("#map-one svg .id-"+e.countrycode).transition().duration(1e3).style("fill","#ff5454")}),l.forEach(function(e){d3.selectAll("#map-one svg .id-"+e).transition().duration(1e3).style("fill","#7e7eb4")})),this.checked&&(s.forEach(function(e){d3.selectAll("#map-one svg .id-"+e.countrycode).transition().duration(1e3).style("fill","#ff5454")}),d.forEach(function(e){d3.selectAll("#map-one svg .id-"+e).transition().duration(1e3).style("fill","#7e7eb4")}))}),$("#mapswitch").change(function(){O.toggle(),O.draw();var e=$(this);e.prop("disabled",!0),setTimeout(function(){e.prop("disabled",!1)},3500),this.checked||d3.selectAll("#map-two text").transition().duration(3e3).style("opacity",.5),this.checked&&d3.selectAll("#map-two text").transition().duration(3e3).style("opacity",0)})})})})});